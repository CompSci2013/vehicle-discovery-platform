<!--
  BASE TABLE COMPONENT TEMPLATE
  Simplified working version
-->

<div class="base-table-container">
  <!-- HEADER: Selection info and buttons -->
  <div
    *ngIf="config.selection?.enabled && config.selection?.showCount"
    class="base-table-header">

    <!-- Selection count -->
    <div class="selection-count">
      {{ getSelectionCount() }} item<span *ngIf="getSelectionCount() !== 1">s</span> selected
    </div>

    <!-- Action buttons -->
    <div class="action-buttons">
      <p-button
        *ngIf="config.selection?.clearButton"
        label="Clear All"
        icon="pi pi-times"
        styleClass="p-button-secondary p-button-outlined"
        (onClick)="onClearSelection()">
      </p-button>

      <p-button
        *ngIf="config.selection?.applyButton?.enabled"
        [label]="config.selection?.applyButton?.text || 'Apply Selection'"
        icon="pi pi-check"
        [disabled]="getSelectionCount() === 0"
        (onClick)="onApplySelection()">
      </p-button>
    </div>
  </div>

  <!-- LOADING STATE -->
  <div *ngIf="loading" class="loading-container">
    <p-progressSpinner></p-progressSpinner>
    <p *ngIf="config.loadingMessage">{{ config.loadingMessage }}</p>
  </div>

  <!-- EMPTY STATE -->
  <div *ngIf="!loading && data.length === 0" class="empty-state">
    <i class="pi pi-inbox empty-icon"></i>
    <p>{{ config.emptyMessage || 'No data available' }}</p>
  </div>

  <!-- TABLE: SINGLE-SELECTOR PICKER PATTERN -->
  <div *ngIf="!loading && data.length > 0 && isSingleSelectorMode()" class="table-wrapper">
    <!-- FILTER ROW (if any column is filterable) -->
    <div *ngIf="hasFilterableColumns()" class="filter-row">
      <div class="filter-cell" style="width: 50px"></div>
      <div *ngFor="let col of getVisibleColumns()" class="filter-cell">
        <input
          *ngIf="col.filterable"
          type="text"
          class="filter-input"
          [placeholder]="'Filter ' + col.label"
          (input)="onFilterColumn(col, $event)"
          [value]="activeFilters[col.key] || ''">
      </div>
      <button *ngIf="getFilterKeys().length > 0" class="clear-filters-btn" (click)="clearAllFilters()">
        Clear Filters
      </button>
    </div>

    <table class="hierarchical-table single-selector-table">
      <!-- HEADER -->
      <thead>
        <tr>
          <th *ngIf="config.expandable?.enabled" style="width: 50px"></th>
          <th style="width: 50px"></th>
          <th *ngFor="let col of getVisibleColumns()"
              [class.sortable]="col.sortable"
              (click)="onSortColumn(col)">
            <div class="column-header">
              <span>{{ col.label }}</span>
              <i *ngIf="col.sortable" [class]="getSortIcon(col)"></i>
            </div>
          </th>
        </tr>
      </thead>

      <!-- BODY: Hierarchical structure with parent rows followed by child rows -->
      <tbody>
        <!-- Parent row for each unique parent value, followed by its children -->
        <ng-container *ngFor="let parentValue of getHierarchicalParents()">
          <!-- Parent row -->
          <tr class="parent-row">
            <td *ngIf="config.expandable?.enabled"></td>
            <td class="checkbox-cell">
              <p-checkbox
                [ngModel]="getParentCheckboxValue(parentValue)"
                [binary]="true"
                (onChange)="onParentCheckboxChange(parentValue, $event)">
              </p-checkbox>
            </td>
            <!-- Parent value in first column -->
            <td class="parent-value-cell" [attr.colspan]="getVisibleColumns().length">
              <strong>{{ parentValue }}</strong>
            </td>
          </tr>

          <!-- Child rows for this parent (indented) -->
          <ng-container *ngFor="let child of getChildrenForParent(parentValue)">
            <tr class="child-row" [class.selected]="isRowSelected(child)">
              <td *ngIf="config.expandable?.enabled" class="checkbox-cell">
                <button
                  pButton
                  [icon]="isRowExpanded(child) ? (config.expandable?.collapseIcon || 'pi pi-chevron-down') : (config.expandable?.expandIcon || 'pi pi-chevron-right')"
                  class="p-button-text p-button-sm"
                  (click)="toggleRowExpansion(child)">
                </button>
              </td>
              <td class="checkbox-cell">
                <p-checkbox
                  [ngModel]="isRowSelected(child)"
                  [binary]="true"
                  (onChange)="onChildCheckboxChange(child, $event)">
                </p-checkbox>
              </td>
              <!-- Data columns for child -->
              <td *ngFor="let col of getVisibleColumns()" class="child-data-cell">
                <span class="child-indent">{{ child[col.key] }}</span>
              </td>
            </tr>

            <!-- Expanded sub-table row -->
            <tr *ngIf="isRowExpanded(child) && config.expandable?.enabled" class="expanded-row">
              <td [attr.colspan]="getVisibleColumns().length + (config.expandable?.enabled ? 1 : 0) + 1">
                <div class="sub-table-container">
                  <app-base-table
                    *ngIf="config.expandable?.subTable"
                    [config]="{
                      id: config.id + '-sub',
                      columns: config.expandable?.subTable?.columns || [],
                      data: getSubTableData(child),
                      striped: true,
                      size: 'small'
                    }">
                  </app-base-table>
                </div>
              </td>
            </tr>
          </ng-container>
        </ng-container>
      </tbody>
    </table>

    <!-- PAGINATION: For hierarchical single-selector table -->
    <p-paginator
      *ngIf="shouldShowPagination()"
      [rows]="rows"
      [totalRecords]="totalRecords"
      [first]="first"
      [rowsPerPageOptions]="config.pagination?.pageSizeOptions || [10, 20, 50, 100]"
      [showCurrentPageReport]="shouldShowCurrentPageReport()"
      [currentPageReportTemplate]="getPageReportTemplate()"
      (onPageChange)="onPageChange($event)">
    </p-paginator>
  </div>

  <!-- TABLE: DUAL-SELECTOR PICKER PATTERN -->
  <div *ngIf="!loading && data.length > 0 && isDualSelectorMode()" class="table-wrapper">
    <!-- FILTER ROW (if any column is filterable) -->
    <div *ngIf="hasFilterableColumns()" class="filter-row">
      <div *ngFor="let col of getVisibleColumns()" class="filter-cell">
        <input
          *ngIf="col.filterable"
          type="text"
          class="filter-input"
          [placeholder]="'Filter ' + col.label"
          (input)="onFilterColumn(col, $event)"
          [value]="activeFilters[col.key] || ''">
      </div>
      <button *ngIf="getFilterKeys().length > 0" class="clear-filters-btn" (click)="clearAllFilters()">
        Clear Filters
      </button>
    </div>

    <table class="hierarchical-table">
      <!-- HEADER -->
      <thead>
        <tr>
          <th *ngIf="config.expandable?.enabled" style="width: 50px"></th>
          <th *ngFor="let col of getVisibleColumns(); let i = index"
              [class.sortable]="col.sortable"
              (click)="onSortColumn(col)">
            <div class="column-header">
              <span>{{ col.label }}</span>
              <i *ngIf="col.sortable" [class]="getSortIcon(col)"></i>
            </div>
          </th>
        </tr>
      </thead>

      <!-- BODY: Each row shows all data columns with embedded checkboxes -->
      <tbody>
        <ng-container *ngFor="let row of data">
        <tr class="data-row">
          <td *ngIf="config.expandable?.enabled" class="checkbox-cell">
            <button
              pButton
              [icon]="isRowExpanded(row) ? (config.expandable?.collapseIcon || 'pi pi-chevron-down') : (config.expandable?.expandIcon || 'pi pi-chevron-right')"
              class="p-button-text p-button-sm"
              (click)="toggleRowExpansion(row)">
            </button>
          </td>
          <td *ngFor="let col of getVisibleColumns(); let colIndex = index">
            <!-- Parent checkbox embedded in parent column (if dual-selector mode) -->
            <!-- PHASE 4 FIX: In dual mode, shows THIS ROW's selection state, but clicking affects ALL rows with that parent -->
            <ng-container *ngIf="shouldShowParentCheckbox(colIndex)">
              <div class="parent-checkbox-wrapper">
                <p-checkbox
                  [ngModel]="getParentCheckboxValue(row[config.selection?.hierarchical?.parentKey || ''], row)"
                  [binary]="true"
                  (onChange)="onParentCheckboxChange(row[config.selection?.hierarchical?.parentKey || ''], $event)">
                </p-checkbox>
              </div>
            </ng-container>

            <!-- Child checkbox embedded in child column (if dual-selector mode) -->
            <ng-container *ngIf="shouldShowChildCheckbox(colIndex)">
              <p-checkbox
                [ngModel]="isRowSelected(row)"
                [binary]="true"
                (onChange)="onChildCheckboxChange(row, $event)"
                class="checkbox-inline">
              </p-checkbox>
            </ng-container>

            <!-- Column value (only if no checkbox in this column) -->
            <span *ngIf="!shouldShowParentCheckbox(colIndex) && !shouldShowChildCheckbox(colIndex)">
              {{ row[col.key] }}
            </span>

            <!-- Column value alongside parent checkbox -->
            <span *ngIf="shouldShowParentCheckbox(colIndex)">
              {{ row[col.key] }}
            </span>

            <!-- Column value alongside child checkbox -->
            <span *ngIf="shouldShowChildCheckbox(colIndex)">
              {{ row[col.key] }}
            </span>
          </td>
        </tr>

        <!-- Expanded sub-table row -->
        <tr *ngIf="isRowExpanded(row) && config.expandable?.enabled" class="expanded-row">
          <td [attr.colspan]="getVisibleColumns().length + (config.expandable?.enabled ? 1 : 0)">
            <div class="sub-table-container">
              <app-base-table
                *ngIf="config.expandable?.subTable"
                [config]="{
                  id: config.id + '-sub',
                  columns: config.expandable?.subTable?.columns || [],
                  data: getSubTableData(row),
                  striped: true,
                  size: 'small'
                }">
              </app-base-table>
            </div>
          </td>
        </tr>
        </ng-container>
      </tbody>
    </table>

    <!-- PAGINATION: For hierarchical dual-selector table -->
    <p-paginator
      *ngIf="shouldShowPagination()"
      [rows]="rows"
      [totalRecords]="totalRecords"
      [first]="first"
      [rowsPerPageOptions]="config.pagination?.pageSizeOptions || [10, 20, 50, 100]"
      [showCurrentPageReport]="shouldShowCurrentPageReport()"
      [currentPageReportTemplate]="getPageReportTemplate()"
      (onPageChange)="onPageChange($event)">
    </p-paginator>
  </div>

  <!-- TABLE: SIMPLE MODE -->
  <div *ngIf="!loading && data.length > 0 && !config.selection?.hierarchical?.enabled" class="table-wrapper">
    <p-table
      [value]="data"
      [paginator]="config.pagination?.enabled || false"
      [rows]="rows"
      [totalRecords]="totalRecords"
      [first]="first"
      [rowsPerPageOptions]="config.pagination?.pageSizeOptions || [10, 20, 50, 100]"
      [showCurrentPageReport]="shouldShowCurrentPageReport()"
      [currentPageReportTemplate]="getPageReportTemplate()"
      styleClass="p-datatable-sm"
      (onPage)="onPageChange($event)">

      <!-- HEADER -->
      <ng-template pTemplate="header">
        <tr>
          <!-- Expand column (if expandable) -->
          <th *ngIf="config.expandable?.enabled" style="width: 50px"></th>

          <!-- Selection column (if selection enabled) -->
          <th *ngIf="config.selection?.enabled" style="width: 50px">
            <p-checkbox
              *ngIf="config.selection?.mode === 'multi'"
              [binary]="true"
              [disabled]="true">
            </p-checkbox>
          </th>

          <!-- Data columns -->
          <th *ngFor="let col of getVisibleColumns()">{{ col.label }}</th>
        </tr>
      </ng-template>

      <!-- BODY -->
      <ng-template pTemplate="body" let-row>
        <!-- Main data row -->
        <tr>
          <!-- Expand button -->
          <td *ngIf="config.expandable?.enabled">
            <button
              pButton
              [icon]="isRowExpanded(row) ? (config.expandable?.collapseIcon || 'pi pi-chevron-down') : (config.expandable?.expandIcon || 'pi pi-chevron-right')"
              class="p-button-text p-button-sm"
              (click)="toggleRowExpansion(row)">
            </button>
          </td>

          <!-- Selection checkbox -->
          <td *ngIf="config.selection?.enabled">
            <p-checkbox
              [ngModel]="isRowSelected(row)"
              [binary]="true"
              (onChange)="onChildCheckboxChange(row, $event)">
            </p-checkbox>
          </td>

          <!-- Data columns -->
          <td *ngFor="let col of getVisibleColumns()">{{ row[col.key] }}</td>
        </tr>

        <!-- Expanded sub-table row -->
        <tr *ngIf="isRowExpanded(row) && config.expandable?.enabled" class="expanded-row">
          <td [attr.colspan]="getVisibleColumns().length + (config.selection?.enabled ? 1 : 0) + (config.expandable?.enabled ? 1 : 0)">
            <div class="sub-table-container">
              <!-- Sub-table (recursive BaseTable) -->
              <app-base-table
                *ngIf="config.expandable?.subTable"
                [config]="{
                  id: config.id + '-sub',
                  columns: config.expandable?.subTable?.columns || [],
                  data: getSubTableData(row),
                  striped: true,
                  size: 'small'
                }">
              </app-base-table>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <!-- FOOTER -->
  <div
    *ngIf="config.selection?.enabled && config.selection?.applyButton?.enabled"
    class="base-table-footer">
    <div class="action-buttons">
      <p-button
        *ngIf="config.selection?.clearButton"
        label="Clear All"
        icon="pi pi-times"
        styleClass="p-button-secondary p-button-outlined"
        (onClick)="onClearSelection()">
      </p-button>

      <p-button
        [label]="config.selection?.applyButton?.text || 'Apply Selection'"
        icon="pi pi-check"
        [disabled]="getSelectionCount() === 0"
        (onClick)="onApplySelection()">
      </p-button>
    </div>
  </div>
</div>
